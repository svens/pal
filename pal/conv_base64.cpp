#include <pal/conv>
#include <array>


__pal_begin


namespace __bits {


char *to_base64 (const uint8_t *first, const uint8_t *last, char *out) noexcept
{
	static constexpr uint8_t map[] =
		"ABCDEFGHIJKLMNOPQRSTUVWXYZ"
		"abcdefghijklmnopqrstuvwxyz"
		"0123456789"
		"+/";

	const auto mod = (last - first) % 3;
	last -= mod;

	for (/**/;  first != last;  first += 3)
	{
		*out++ = map[first[0] >> 2];
		*out++ = map[((first[0] << 4) | (first[1] >> 4)) & 0b00111111];
		*out++ = map[((first[1] << 2) | (first[2] >> 6)) & 0b00111111];
		*out++ = map[first[2] & 0b00111111];
	}

	if (mod == 1)
	{
		*out++ = map[first[0] >> 2];
		*out++ = map[((first[0] << 4)) & 0b00111111];
		*out++ = '=';
		*out++ = '=';
	}
	else if (mod == 2)
	{
		*out++ = map[first[0] >> 2];
		*out++ = map[((first[0] << 4) | (first[1] >> 4)) & 0b00111111];
		*out++ = map[(first[1] << 2) & 0b00111111];
		*out++ = '=';
	}

	return out;
}


char *from_base64 (const uint8_t *first, const uint8_t *last, char *out) noexcept
{
	static constexpr std::array<uint8_t, 256> map =
	{
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x3e, 0xff, 0xff, 0xff, 0x3f,
		0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e,
		0x0f, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
		0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30, 0x31, 0x32, 0x33, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
		0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	};

	if ((last - first) % 4 != 0)
	{
		return nullptr;
	}

	const int pad = (last[-1] == '=') + (last[-2] == '=');
	const auto end = first + ((last - first - pad) / 4) * 4;
	uint8_t b0, b1, b2, b3;

	while (first != end)
	{
		b0 = map[first[0]];
		b1 = map[first[1]];
		b2 = map[first[2]];
		b3 = map[first[3]];
		if (b0 != 0xff && b1 != 0xff && b2 != 0xff && b3 != 0xff)
		{
			auto v = (b0 << 18) | (b1 << 12) | (b2 << 6) | b3;
			*out++ = (v >> 16) & 0xff;
			*out++ = (v >> 8) & 0xff;
			*out++ = v & 0xff;
			first += 4;
		}
		else
		{
			return nullptr;
		}
	}

	if (pad == 1)
	{
		b0 = map[first[0]];
		b1 = map[first[1]];
		b2 = map[first[2]];
		if (b0 != 0xff && b1 != 0xff && b2 != 0xff)
		{
			auto v = (b0 << 18) | (b1 << 12) | (b2 << 6);
			*out++ = (v >> 16) & 0xff;
			*out++ = (v >> 8) & 0xff;
		}
		else
		{
			return nullptr;
		}
	}
	else if (pad == 2)
	{
		b0 = map[first[0]];
		b1 = map[first[1]];
		if (b0 != 0xff && b1 != 0xff)
		{
			*out++ = ((b0 << 18) | (b1 << 12)) >> 16;
		}
		else
		{
			return nullptr;
		}
	}

	return out;
}


} // namespace __bits


__pal_end
