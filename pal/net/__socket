#pragma once // -*- C++ -*-

#include <pal/result>
#include <pal/version>
#include <memory>

#if __pal_os_linux || __pal_os_macos
	#define __pal_net_posix 1
	#define __pal_net_winsock 0
	#include <sys/socket.h>
	#include <unistd.h>
#elif __pal_os_windows
	#define __pal_net_posix 0
	#define __pal_net_winsock 1
	#include <winsock2.h>
#endif

namespace pal::net::__socket {

#if __pal_net_posix
inline unexpected<std::error_code> sys_error (int e = errno) noexcept
{
	return unexpected<std::error_code>{std::in_place, e, std::generic_category()};
}
#elif __pal_net_winsock
inline unexpected<std::error_code> sys_error (int e = ::WSAGetLastError()) noexcept
{
	if (e == WSAENOTSOCK || e == WSA_INVALID_HANDLE)
	{
		// unify with Posix
		e = WSAEBADF;
	}
	return unexpected<std::error_code>{std::in_place, e, std::system_category()};
}
#endif

struct native_handle
{
	#if __pal_net_posix
		using type = int;
		static constexpr type invalid = -1;
	#elif __pal_net_winsock
		using type = ::SOCKET;
		static constexpr type invalid = INVALID_SOCKET;
	#endif

	type handle = invalid;

	constexpr native_handle () = default;

	constexpr native_handle (std::nullptr_t)
	{ }

	constexpr native_handle (type handle) noexcept
		: handle{handle}
	{ }

	constexpr explicit operator bool () const noexcept
	{
		return handle != invalid;
	}

	constexpr native_handle *operator-> () noexcept
	{
		return this;
	}

	constexpr const native_handle *operator-> () const noexcept
	{
		return this;
	}

	constexpr friend bool operator== (const native_handle &a, const native_handle &b) noexcept
	{
		return a.handle == b.handle;
	}

	constexpr friend bool operator!= (const native_handle &a, const native_handle &b) noexcept
	{
		return !(a == b);
	}

	struct deleter
	{
		using pointer = native_handle;

		void operator() (pointer socket) const noexcept
		{
			#if __pal_net_posix
				::close(socket->handle);
			#elif __pal_net_winsock
				::closesocket(socket->handle);
			#endif
		}
	};
};

using native_socket = std::unique_ptr<native_handle, native_handle::deleter>;

inline result<native_socket> make (int domain, int type, int protocol) noexcept
{
	if (auto value = ::socket(domain, type, protocol); value != native_handle::invalid)
	{
		return native_socket{value};
	}
	return sys_error();
}

} // namespace pal::net::__socket
